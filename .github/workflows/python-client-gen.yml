name: Python Client Generation soemthing
# re-generates the python client when a new release
# of digitalocean/openapi is cut.
# Creates a PR with the changes
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'The release version of digitalocean/openapi that triggered this.'
        required: true
        type: string
jobs:
  Generate-Python-Client:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Removes all generated code
      run: make clean
    - name: Download spec file and Update DO_OPENAPI_VERSION.txt
      run: |
        gh release download --repo digitalocean/openapi ${{ github.event.inputs.release_version }} --pattern 'openapi-bundled.yaml' > DigitalOcean-public.v2.yaml
        ${{ github.event.inputs.release_version }} > DO_OPENAPI_VERSION.txt
      env:
        GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
    - uses: actions/upload-artifact@v2
      with:
        name: DigitalOcean-public.v2
        path: ./DigitalOcean-public.v2.yaml
    - name: Checkout new Branch
      run: git checkout -b ${{ github.event.inputs.release_version }}
      env:
        GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}   
    - name: Generate Python client
      run: make generate
    - name: Add and commit changes
      run: |
        git config --global user.email "delhertani@digitalocean.com"
        git config --global user.name "Dana Elhertani"
        git add .
        git commit -m "[bot] Updated client"
        git push --set-upstream origin ${{ github.event.inputs.release_version }}
      env:
        GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}  
    - name: Create Pull Request
      run: gh pr create --title "[bot] Re-Generate w/ digitalocean/openapi ${{ github.event.inputs.release_version }}" --body "Regenerate python client with the ${{ github.event.inputs.release_version }} release of digitalocean/openapi. Owners must review to confirm if integration/mocked tests need to be added to the client to reflect the changes." --head ${{ github.event.inputs.release_version }} -r owners
      env:
        GH_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}    